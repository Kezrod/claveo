---
  import "../styles/styles.css";
---

<header class="bg-[var(--color-navbar)] w-full flex items-center justify-end px-8 py-2 text-text">
  <a 
    id="authButton"
    href="/login" 
    class="bg-[var(--color-accent)] hover:bg-accent-hover transition px-4 py-2 rounded-lg font-semibold text-white text-sm"
  >
    Iniciar sesi√≥n
  </a>
</header>

<!-- üì¶ Contenedor principal -->
<div class="min-h-screen flex items-center justify-center bg-bg text-text pb-12">
  <div id="authContainer" class="bg-white text-black rounded-xl shadow-xl p-8 w-full max-w-md border border-border transition-all duration-300">

    <!-- üßë‚Äçüíª Login (visible por defecto) -->
    <div id="loginForm">
      <h1 class="text-3xl font-extrabold text-center mb-6">Bienvenido a Claveo</h1>
      <p class="text-center text-sm text-gray-600 mb-8">Inicia sesi√≥n para continuar</p>

      <form class="flex flex-col gap-5" id="loginFormSubmit">
        <div>
          <label for="email" class="block text-sm font-semibold mb-2 text-black">Correo electr√≥nico</label>
          <input
            type="email"
            id="email"
            placeholder="tucorreo@ejemplo.com"
            class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black focus:outline-none focus:ring-2 focus:ring-accent placeholder-gray-400"
            required
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-semibold mb-2 text-black">Contrase√±a</label>
          <input
            type="password"
            id="password"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black focus:outline-none focus:ring-2 focus:ring-accent placeholder-gray-400"
            required
          />
        </div>

        <button
          type="submit"
          class="w-full bg-[var(--color-accent)] hover:bg-accent-hover text-white font-semibold py-2 rounded-lg transition"
        >
          Iniciar sesi√≥n
        </button>
      </form>

      <div class="text-center mt-6 space-y-2">
        <button id="showRegister" class="block w-full text-accent hover:underline text-sm font-semibold">
          Crear cuenta
        </button>
        <a href="#" class="block text-gray-500 hover:underline text-xs">
          ¬øOlvidaste tu contrase√±a?
        </a>
      </div>
    </div>

    <!-- üÜï Formulario de registro (oculto por defecto) -->
    <div id="registerContainer" class="hidden">
      <h2 class="text-3xl font-bold mb-6 text-center text-black">Crear cuenta</h2>

      <form id="registerForm" class="flex flex-col gap-4">
        <div>
          <label for="name" class="block text-sm font-semibold mb-2 text-black">Nombre completo</label>
          <input type="text" name="name" id="name" placeholder="Tu nombre completo" class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black" required />
        </div>

        <div>
          <label for="birthdate" class="block text-sm font-semibold mb-2 text-black">Fecha de nacimiento</label>
          <input type="date" name="birthdate" id="birthdate" class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black" required />
        </div>

        <div>
          <label for="email" class="block text-sm font-semibold mb-2 text-black">Correo electr√≥nico</label>
          <input type="email" name="email" id="regEmail" placeholder="tucorreo@ejemplo.com" class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black" required />
        </div>

        <div>
          <label for="password" class="block text-sm font-semibold mb-2 text-black">Contrase√±a</label>
          <input type="password" name="password" id="regPassword" placeholder="Crea una contrase√±a" class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black" required />
        </div>

        <div>
          <label for="confirmPassword" class="block text-sm font-semibold mb-2 text-black">Confirmar contrase√±a</label>
          <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Repite tu contrase√±a" class="w-full px-4 py-2 rounded-lg border border-border bg-white text-black" required />
        </div>

        <button type="submit" class="w-full bg-[var(--color-accent)] hover:bg-accent-hover p-3 rounded font-semibold text-white">
          Crear cuenta
        </button>

        <p id="msg" class="text-center text-sm mt-2"></p>
      </form>

      <button id="showLogin" class="w-full mt-4 text-accent hover:underline text-sm font-semibold text-center">
        Volver al login
      </button>
    </div>
  </div>
</div>

<!-- üìú Script para alternar formularios, crear usuario e iniciar sesi√≥n -->
<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const loginForm = document.getElementById("loginForm");
    const registerContainer = document.getElementById("registerContainer");
    const showRegisterBtn = document.getElementById("showRegister");
    const showLoginBtn = document.getElementById("showLogin");
    const registerForm = document.getElementById("registerForm");
    const msg = document.getElementById("msg");

    // üü£ Alternar formularios
    showRegisterBtn?.addEventListener("click", () => {
      loginForm.classList.add("hidden");
      registerContainer.classList.remove("hidden");
    });

    showLoginBtn?.addEventListener("click", () => {
      registerContainer.classList.add("hidden");
      loginForm.classList.remove("hidden");
    });

    // üõ†Ô∏è Crear usuario
    registerForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(registerForm);
      const password = formData.get("password");
      const confirmPassword = formData.get("confirmPassword");

      if (password !== confirmPassword) {
        msg.textContent = "‚ùå Las contrase√±as no coinciden.";
        msg.className = "text-red-500 text-center";
        return;
      }

      const data = {
        name: formData.get("name"),
        email: formData.get("email"),
        password,
        birthdate: formData.get("birthdate"),
      };

      try {
        const res = await fetch("/api/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await res.json();

        if (res.ok) {
          msg.textContent = "‚úÖ Cuenta creada con √©xito. Ahora puedes iniciar sesi√≥n.";
          msg.className = "text-green-500 text-center";
          registerForm.reset();

          setTimeout(() => {
            registerContainer.classList.add("hidden");
            loginForm.classList.remove("hidden");
          }, 2000);
        } else {
          msg.textContent = "‚ùå " + result.error;
          msg.className = "text-red-500 text-center";
        }
      } catch (err) {
        msg.textContent = "‚ùå Error al conectar con el servidor.";
        msg.className = "text-red-500 text-center";
      }
    });

    // ‚úÖ Iniciar sesi√≥n
    const loginFormSubmit = document.getElementById("loginFormSubmit");
    loginFormSubmit.addEventListener("submit", async (e) => {
      e.preventDefault();

      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        const result = await res.json();

        if (res.ok) {
          // ‚úÖ Guardar sesi√≥n
          localStorage.setItem("user", JSON.stringify(result.user));

          // ‚úÖ Redirigir al index
          window.location.href = "/";
        } else {
          alert("‚ùå " + result.error);
        }
      } catch (err) {
        alert("‚ùå Error al conectar con el servidor.");
      }
    });

    // üîÅ Cambiar bot√≥n a "Cerrar sesi√≥n" si hay sesi√≥n activa
    const authButton = document.getElementById("authButton");
    const user = localStorage.getItem("user");

    if (user) {
      authButton.textContent = "Cerrar sesi√≥n";
      authButton.href = "#";
      authButton.addEventListener("click", () => {
        localStorage.removeItem("user");
        window.location.href = "/";
      });
    }
  });
</script>
